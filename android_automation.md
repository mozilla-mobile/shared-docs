# Automation and continuous integration systems

Our Android projects share a similar automation model:
- Taskcluster is our primary CI: we use it for as much automation as
possible, including our core builds and releases, because it's a
flexible first party service we can rely on.
- Travis is secondary: we use it to get automation working quickly or get
support for tools that won't work on Taskcluster.

## Taskcluster

[Taskcluster][tc] is a generic task execution framework developed and used by Mozilla to automate continuous integration and release processes.

We currently use Taskcluster to:
* Build, test and run code tools for all master commits and pull requests
(including contributor PRs). See [Code quality tools](#code-quality-tools)
for additional information.
* Build (unsigned) release builds whenever a release is created on GitHub
* Automatically import new translations from the L10N repository.

To see a Taskcluster configuration for your project, see
`<project-root>/.taskcluster.yml` (here's an
[example in focus-android][tc yml]).

Taskcluster runs using docker: see our [docker guide] for more information.

## Travis

[Travis] is an easy-to-configure continuous integration environment with
great support for GitHub.

We currently use Travis to:
* Build, test and run code tools for all master commits and pull requests (including contributor PRs).
* Execute sputnik for posting automated code feedback in pull requests
* Execute codecov for monitoring our code coverage

To see a travis configuration for your project, see `<project-root>/.travis.yml` (here's an
[example in focus-android][travis yml]).

You can also find build logs on the travis website, e.g. for focus-android: https://travis-ci.org/mozilla-mobile/focus-android

# Code quality tools

For Java/Kotlin projects, we like to run the following tools:
* findbugs
* PMD
* Android lint
* checkstyle
* [detekt](https://github.com/arturbosch/detekt)
* [ktlint](https://github.com/shyiko/ktlint)

To see what tools are currently run in automation for your project, see
the project's `<project-root>/.taskcluster.yml`
(here's an [example in focus-android][tc yml tools]).

# Third-party services

## Sputnik

Sputnik (riggered from travis) runs findbugs, PMD and checkstyle on code attached to pull requests and posts in-line comments whenever violations are found.

* https://sputnik.ci

## Codecov

Codecov evaluates the code coverage reports generated by our build and tracks the coverage over time. It warns when merging pull requests would lead to dropping the coverage below a specified threshold.

* https://codecov.io/gh
* [focus-android code coverage over time](https://codecov.io/gh/mozilla-mobile/focus-android/branch/master)

# Automation tasks

## Pull request pipeline

![](https://i.imgur.com/SJ9zSs8.png)

## Release pipeline

Eventually we want to automate the whole release process pipeline in order to have "one click" releases without much workload for the engineering team.

### ‚úÖ Active: Release builds

Whenever a release is created on GitHub we build releases versions of Focus and Klar on taskcluster.

* [Configuration](https://github.com/mozilla-mobile/focus-android/blob/master/.taskcluster.yml#L91)

### üìì Planned: Signing

Signing requires access to Mozilla's signing certificates. In addition to that a signing task needs to be able to validate the origin of the APK ("Can I trust the task that built the APK?") to avoid signing random tasks. To get this task up and running we need help from the release engineering team.

Currently this is done manually by the release engineering team after we open a signing request bug on Bugzilla.

* [Chain of Trust](http://scriptworker.readthedocs.io/en/latest/chain_of_trust.html)
* [pushapkscript](https://github.com/mozilla-releng/pushapkscript)

### üìì Planned: Upload to archive.mozilla.org

We want to publish every release on archive.mozilla.org. Currently we upload those builds manually. In automation this will be done by  the beetmover_scriptworker.

Before we can automate this task we need to automate signing builds and have a chain of trust.

* [beetmover script](https://github.com/mozilla-releng/beetmoverscript/)
* [beetmover configuration for Fennec](https://github.com/mozilla-releng/beetmoverscript/blob/master/beetmoverscript/templates/fennec_nightly.yml)

### üìì Planned: Release signoff

This is a dummy task that does nothing except waiting on somebody to complete it. After the build is tested and the release stakeholders agree to ship, someone from the Focus team will use the taskcluster-cli tool to manually resolve this task.

* [taskcluster ci](https://github.com/taskcluster/taskcluster-cli)

### üìì Planned: Publish

Finally we want to publish a release build on Google Play

Like other scriptworker instances, we can use the existing instance. The current implementation is fennec-specific. We have to add support there too. pushapk_scriptworker mainly delegates checks and uploads to mozapkpublisher. That tool needs Focus support. Working on mozapkpublisher doesn't require any Taskcluster knowledge.

* [pushapkscript](https://github.com/mozilla-releng/pushapkscript)
* [mozapkpublisher](https://github.com/mozilla-releng/mozapkpublisher)

## Nightly (Alpha) pipeline

We want to build Nightly versions from master. Those Nightly builds should be distributed via the Google Play Alpha channel and replace distributing via buddybuild. Updates via buddybuild require manual download and installation of updates. With Google Play builds can update automatically in the background.

The Alpha channel is not intended to be public like the Beta channel. However it should be open to the L10N teams and interested contributors.

The pipeline for Nightly builds looks like the release sign-off pipeline without the upload and sign-off tasks.

* üìì Planned: Build (triggered via taskcluster hook)
* üìì Planned: Signing
* üìì Planned: Upload to Google Play
* üìì Planned: Publish on Alpha channel

## Maintenance tasks

### ‚úÖ Active: String import

Every day at 12:00 UTC we run a script that imports the latest translations from the L10N repository and creates a pull request for the import if there are new strings. Eventually this import can be merged automatically. For now we want to review those changes manually to validate that the task is running as intended.

* [Task script](https://github.com/mozilla-mobile/focus-android/blob/master/tools/taskcluster/import_strings_and_create_pull_request.sh)
* [Hook and task definition](https://tools.taskcluster.net/hooks/project-focus/strings-import)

### ‚öôÔ∏è In progress: Screenshots

Taking screenshots is a long running progress. On taskcluster we can run this automatically and for multiple locales in parallel.

We are using **fastlane *screengrab*** to take screenshots of the app in different locales. Screengrab will run a subset of UI tests that include screenshot commands. The tool will take care of changing the locale, re-running the tests and generating a HTML page containing all screenshots.

* [Screengrab docs](https://docs.fastlane.tools/actions/screengrab/)

For automating the screenshot process our plan is to run screengrab on taskcluster using an emulator. After that we upload the screenshots to a S3 bucket that can be accessed from a static URL.

On taskcluster we execute our [schedule-screenshots.py](https://github.com/mozilla-mobile/focus-android/blob/master/tools/taskcluster/schedule-screenshots.py) script. This script will generate multiple child screenshot tasks for a subset of locales (~5 locales per task). This allows us to parallelize the work. Previously in our tests a single task required about 5 hours to run the test suite for all locales.

A screenshot child task will execute [take-screenshots.sh](https://github.com/mozilla-mobile/focus-android/blob/master/tools/taskcluster/take-screenshots.sh) which will spin up an emulator and run screengrab.

We haven't implemented a taskcluster hook for taking screenshots yet. So far we have been testing this from a pull request with modified taskcluster configuration:
https://github.com/mozilla-mobile/focus-android/pull/1719/files

Some problems we are facing:
* On taskcluster (or more precisely: in Docker) we are running ARM emulators without hardware acceleration. They are pretty slow and have been making tests unreliably because of timing issues. See #1367 for example.
* Our emulator has to run with "-gpu off". With that screengrab can't use uiautomator to take screenshots. We wrote a workaround implementation that will execute screencap  (Don't get confused: screengrab <-> screencap) from the host system: [screencap-server.py](https://github.com/mozilla-mobile/focus-android/blob/master/tools/taskcluster/screencap-server.py)

To investigate:
* Can we run the emulator with hardware acceleration? Some research seems to indicate that Docker needs to have access to the KVM of the host machine. This might require a special type of taskcluster worker. If this (hardware accelerated emulator inside Docker) can be verified locally then we can ask the taskcluster team to help us with setting that up.
* Can we stabilize our current set of UI tests with the current setup? The task itself does not need to be fast. Screenshots need to be generated infrequently.
* Currently we use an API 21 (Android 5.0) emulator in automation. Are our tests more reliable on a newer version? Note that this might require updating the Docker image. By default we only install the API 21 runtime.
* How should we upload to S3? For builds [beetmover](https://github.com/mozilla-releng/beetmoverscript/) is used. But this will require a ChainOfTrust again. Could we upload from the screenshot task itself? Is this a security risk?
* What S3 bucket (and URL) should we use? We need a setup similar to archive.mozilla.org. However archive.mozilla.org itself might not be suitable as we only want to save the last state of screenshots somewhere. Cloud services might have an opinion on that. See [bug 1402804](https://bugzilla.mozilla.org/show_bug.cgi?id=1402804) for a related request.

[docker guide]: https://github.com/mozilla-mobile/shared-docs/blob/master/docker_guide.md
[tc yml]: https://github.com/mozilla-mobile/focus-android/blob/master/.taskcluster.yml
[tc yml tools]: https://github.com/mozilla-mobile/focus-android/blob/38f79e25493ab08b8322cd4c059891f37fbf500f/.taskcluster.yml#L39
[tc]: https://docs.taskcluster.net/docs
[travis]: https://travis-ci.org/
[travis yml]: https://github.com/mozilla-mobile/focus-android/blob/master/.travis.yml
